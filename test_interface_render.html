<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF API Test Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .endpoint-card {
            margin-bottom: 1rem;
        }
        .response-area {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .auth-section {
            background-color: #e9ecef;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .document-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .document-preview {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .document-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .document-info {
            padding: 10px;
        }
        .document-title {
            font-size: 0.9rem;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .document-date {
            font-size: 0.8rem;
            color: #666;
            margin: 5px 0;
        }
        .document-actions {
            display: flex;
            gap: 5px;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        .document-actions button {
            flex: 1;
            font-size: 0.8rem;
            padding: 5px;
        }
        .loading-preview {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
        }
        .preview-container {
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            background: #f8f9fa;
        }
        .preview-container iframe {
            width: 100%;
            height: 500px;
            border: none;
        }
        .preview-container img {
            max-width: 100%;
            height: auto;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">PDF API Test Interface</h1>
        
        <!-- Authentication Section -->
        <div class="auth-section">
            <h3>Authentication</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Email/Password Sign In</h5>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="loginEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Sign In</button>
                            </form>
                            <hr>
                            <h6>Or register a new account</h6>
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label for="registerEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="registerEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="registerPassword" required>
                                </div>
                                <button type="submit" class="btn btn-secondary">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Google Sign In</h5>
                            <button id="googleSignInBtn" class="btn btn-primary">Sign in with Google</button>
                            <div class="response-area mt-3" id="authResponse"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Operations Section -->
        <h3 class="mt-4">Document Operations</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Upload PDF</h5>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="file" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        <div class="response-area mt-3" id="uploadResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Your Documents</h5>
                        <button class="btn btn-primary" onclick="listDocuments()">Refresh List</button>
                        <div class="response-area mt-3" id="listResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Management Section -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Document Details</h5>
                        <form id="documentDetailsForm">
                            <div class="mb-3">
                                <label for="documentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="documentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Get Details</button>
                        </form>
                        <div class="response-area mt-3" id="documentDetailsResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Delete Document</h5>
                        <form id="deleteDocumentForm">
                            <div class="mb-3">
                                <label for="deleteDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="deleteDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                        <div class="response-area mt-3" id="deleteDocumentResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Conversion Section -->
        <h3 class="mt-4">File Conversion</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Image to PDF</h5>
                        <form id="imageToPdfForm">
                            <div class="mb-3">
                                <label for="imageFiles" class="form-label">Select Images</label>
                                <input type="file" class="form-control" id="imageFiles" accept="image/*" multiple required>
                            </div>
                            <button type="submit" class="btn btn-primary">Convert to PDF</button>
                        </form>
                        <div class="response-area mt-3" id="imageToPdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Office to PDF</h5>
                        <ul class="nav nav-tabs" id="officeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="word-tab" data-bs-toggle="tab" data-bs-target="#word" type="button" role="tab">Word</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel" type="button" role="tab">Excel</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ppt-tab" data-bs-toggle="tab" data-bs-target="#ppt" type="button" role="tab">PowerPoint</button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3" id="officeTabContent">
                            <div class="tab-pane fade show active" id="word" role="tabpanel">
                                <form id="wordToPdfForm">
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label">Select Word Document</label>
                                        <input type="file" class="form-control" id="wordFile" accept=".doc,.docx" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Convert to PDF</button>
                                </form>
                                <div class="response-area mt-3" id="wordToPdfResponse">
                                    <div class="preview-container" id="wordPreview"></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="excel" role="tabpanel">
                                <form id="excelToPdfForm">
                                    <div class="mb-3">
                                        <label for="excelFile" class="form-label">Select Excel Document</label>
                                        <input type="file" class="form-control" id="excelFile" accept=".xls,.xlsx" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Convert to PDF</button>
                                </form>
                                <div class="response-area mt-3" id="excelToPdfResponse">
                                    <div class="preview-container" id="excelPreview"></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="ppt" role="tabpanel">
                                <form id="pptToPdfForm">
                                    <div class="mb-3">
                                        <label for="pptFile" class="form-label">Select PowerPoint Document</label>
                                        <input type="file" class="form-control" id="pptFile" accept=".ppt,.pptx" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Convert to PDF</button>
                                </form>
                                <div class="response-area mt-3" id="pptToPdfResponse">
                                    <div class="preview-container" id="pptPreview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Operations Section -->
        <h3 class="mt-4">PDF Operations</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Split PDF</h5>
                        <form id="splitPdfForm">
                            <div class="mb-3">
                                <label for="splitDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="splitDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Split PDF</button>
                        </form>
                        <div class="response-area mt-3" id="splitPdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Compress PDF</h5>
                        <form id="compressPdfForm">
                            <div class="mb-3">
                                <label for="compressDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="compressDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Compress PDF</button>
                        </form>
                        <div class="response-area mt-3" id="compressPdfResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Merge PDFs</h5>
                        <form id="mergePdfForm">
                            <div class="mb-3">
                                <label for="mergeDocumentIds" class="form-label">Document IDs (comma-separated)</label>
                                <input type="text" class="form-control" id="mergeDocumentIds" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Merge PDFs</button>
                        </form>
                        <div class="response-area mt-3" id="mergePdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Watermark PDF</h5>
                        <form id="watermarkPdfForm">
                            <div class="mb-3">
                                <label for="watermarkDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="watermarkDocumentId" required>
                            </div>
                            <div class="mb-3">
                                <label for="watermarkText" class="form-label">Watermark Text</label>
                                <input type="text" class="form-control" id="watermarkText" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Watermark</button>
                        </form>
                        <div class="response-area mt-3" id="watermarkPdfResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Rotate PDF</h5>
                        <form id="rotatePdfForm">
                            <div class="mb-3">
                                <label for="rotateDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="rotateDocumentId" required>
                            </div>
                            <div class="mb-3">
                                <label for="rotationAngle" class="form-label">Rotation Angle (degrees)</label>
                                <select class="form-control" id="rotationAngle" required>
                                    <option value="90">90°</option>
                                    <option value="180">180°</option>
                                    <option value="270">270°</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Rotate PDF</button>
                        </form>
                        <div class="response-area mt-3" id="rotatePdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Extract Text (OCR)</h5>
                        <form id="extractTextForm">
                            <div class="mb-3">
                                <label for="extractTextDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="extractTextDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Extract Text</button>
                        </form>
                        <div class="response-area mt-3" id="extractTextResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Features Section -->
        <h3 class="mt-4">AI Features</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Chat with PDF</h5>
                        <form id="chatForm">
                            <div class="mb-3">
                                <label for="chatDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="chatDocumentId" required>
                            </div>
                            <div class="mb-3">
                                <label for="chatMessage" class="form-label">Message</label>
                                <textarea class="form-control" id="chatMessage" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Message</button>
                        </form>
                        <div class="response-area mt-3" id="chatResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Grammar Check</h5>
                        <form id="grammarForm">
                            <div class="mb-3">
                                <label for="grammarText" class="form-label">Text to Check</label>
                                <textarea class="form-control" id="grammarText" rows="4" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Check Grammar</button>
                        </form>
                        <div class="response-area mt-3" id="grammarResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Summarize PDF</h5>
                        <form id="summarizeForm">
                            <div class="mb-3">
                                <label for="summarizeDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="summarizeDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Summarize</button>
                        </form>
                        <div class="response-area mt-3" id="summarizeResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Convert to EPUB</h5>
                        <form id="epubForm">
                            <div class="mb-3">
                                <label for="epubDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="epubDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Convert to EPUB</button>
                        </form>
                        <div class="response-area mt-3" id="epubResponse"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API base URL
        const API_BASE_URL = 'https://redanpdf-1.onrender.com/api/v1';
        
        // Get token from localStorage
        function getToken() {
            return localStorage.getItem('token');
        }

        // Generic API call function
        async function callAPI(endpoint, data = null, method = 'GET', isFormData = false) {
            try {
                const token = getToken();
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const headers = {
                    'Authorization': `Bearer ${token}`
                };

                if (!isFormData) {
                    headers['Content-Type'] = 'application/json';
                }

                const options = {
                    method: method,
                    headers: headers,
                    mode: 'cors'  // Enable CORS
                };

                if (data) {
                    options.body = isFormData ? data : JSON.stringify(data);
                }

                console.log(`Making ${method} request to ${API_BASE_URL}${endpoint}`);  // Debug log

                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Network error' }));
                    console.error('API Error Response:', errorData);  // Debug log
                    throw new Error(errorData.detail || `API request failed with status ${response.status}`);
                }

                // Handle file downloads
                const contentType = response.headers.get('content-type');
                if (contentType && (contentType.includes('application/pdf') || contentType.includes('image/'))) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `converted_${Date.now()}.${contentType.includes('pdf') ? 'pdf' : 'jpg'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    return { message: 'File downloaded successfully' };
                }

                // Handle JSON responses
                const responseData = await response.json();
                if (responseData.download_url) {
                    // Create a download link for the file
                    const downloadLink = document.createElement('a');
                    downloadLink.href = `${API_BASE_URL}${responseData.download_url}`;
                    downloadLink.download = responseData.filename || `converted_${Date.now()}`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                }
                return responseData;
            } catch (error) {
                console.error('API Error:', error);
                if (error.message === 'Failed to fetch') {
                    throw new Error('Unable to connect to the server. The server might be starting up or experiencing issues. Please try again in a few moments.');
                }
                throw error;
            }
        }

        // Set response in UI
        function setResponse(elementId, message, data = null) {
            const element = document.getElementById(elementId);
            if (data) {
                element.innerHTML = `<div class="alert alert-success">${message}</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                element.innerHTML = `<div class="alert alert-info">${message}</div>`;
            }
        }

        // Set error in UI
        function setError(elementId, error) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const formData = new URLSearchParams();
                formData.append('username', email); // API expects 'username' field for email
                formData.append('password', password);

                const response = await fetch(`${API_BASE_URL}/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('token', data.access_token);
                document.getElementById('authResponse').innerHTML = 
                    `<div class="alert alert-success">Signed in as ${email}</div>`;
                listDocuments(); // Load documents after successful login
            } catch (error) {
                setError('authResponse', error);
            }
        });

        // Register handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Registration failed');
                }

                // After successful registration, log in the user
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const loginResponse = await fetch(`${API_BASE_URL}/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                if (!loginResponse.ok) {
                    throw new Error('Registration successful but login failed');
                }

                const loginData = await loginResponse.json();
                localStorage.setItem('token', loginData.access_token);
                document.getElementById('authResponse').innerHTML = 
                    `<div class="alert alert-success">Registered and signed in as ${email}</div>`;
                listDocuments(); // Load documents after successful registration
            } catch (error) {
                setError('authResponse', error);
            }
        });

        // Sign Out
        function signOut() {
            localStorage.removeItem('token');
            document.getElementById('authResponse').innerHTML = 
                `<div class="alert alert-info">Signed out successfully</div>`;
            document.getElementById('listResponse').innerHTML = '';
        }

        // Document upload handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            if (!file) {
                setError('uploadResponse', new Error('Please select a file'));
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const result = await callAPI('/documents/upload', formData, 'POST', true);
                setResponse('uploadResponse', 'File uploaded successfully', result);
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('uploadResponse', error);
            }
        });

        // List documents
        async function listDocuments() {
            try {
                const documents = await callAPI('/documents/list');
                setResponse('listResponse', 'Documents retrieved successfully', documents);
            } catch (error) {
                setError('listResponse', error);
            }
        }

        // Chat with PDF handler
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('chatDocumentId').value;
            const message = document.getElementById('chatMessage').value;
            
            try {
                const result = await callAPI('/ai/chat', {
                    query: message,
                    document_id: documentId
                }, 'POST');
                setResponse('chatResponse', 'Chat response received', result);
            } catch (error) {
                setError('chatResponse', error);
            }
        });

        // Summarize PDF handler
        document.getElementById('summarizeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('summarizeDocumentId').value;
            
            try {
                const result = await callAPI(`/ai/summarize/${documentId}`, null, 'POST');
                setResponse('summarizeResponse', 'Summary generated', result);
            } catch (error) {
                setError('summarizeResponse', error);
            }
        });

        // Grammar check handler
        document.getElementById('grammarForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('grammarText').value;
            
            try {
                const result = await callAPI('/ai/grammar-check', {
                    text: text
                }, 'POST');
                setResponse('grammarResponse', 'Grammar check completed', result);
            } catch (error) {
                setError('grammarResponse', error);
            }
        });

        // Merge PDFs handler
        document.getElementById('mergePdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentIds = document.getElementById('mergeDocumentIds').value.split(',').map(id => id.trim());
            const outputFilename = document.getElementById('mergeOutputFilename').value || 'merged.pdf';
            
            const formData = new FormData();
            documentIds.forEach(id => formData.append('document_ids', id));
            formData.append('output_filename', outputFilename);
            
            try {
                const result = await callAPI('/documents/merge', formData, 'POST', true);
                setResponse('mergePdfResponse', 'PDFs merged successfully', result);
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('mergePdfResponse', error);
            }
        });

        // Watermark PDF handler
        document.getElementById('watermarkPdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('watermarkDocumentId').value;
            const watermarkText = document.getElementById('watermarkText').value;
            
            const formData = new FormData();
            formData.append('text', watermarkText);
            
            try {
                const result = await callAPI(`/documents/${documentId}/watermark`, formData, 'POST', true);
                setResponse('watermarkPdfResponse', 'Watermark added successfully', result);
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('watermarkPdfResponse', error);
            }
        });

        // Rotate PDF handler
        document.getElementById('rotatePdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('rotateDocumentId').value;
            const angle = document.getElementById('rotationAngle').value;
            
            const formData = new FormData();
            formData.append('angle', angle);
            
            try {
                const result = await callAPI(`/documents/${documentId}/rotate`, formData, 'POST', true);
                setResponse('rotatePdfResponse', 'PDF rotated successfully', result);
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('rotatePdfResponse', error);
            }
        });

        // Extract text handler
        document.getElementById('extractTextForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('extractTextDocumentId').value;
            
            try {
                const result = await callAPI(`/documents/${documentId}/extract-text`, null, 'GET');
                setResponse('extractTextResponse', 'Text extracted successfully', result);
            } catch (error) {
                setError('extractTextResponse', error);
            }
        });

        // Convert to EPUB handler
        document.getElementById('epubForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('epubDocumentId').value;
            
            try {
                const result = await callAPI(`/documents/${documentId}/to-epub`, null, 'POST');
                setResponse('epubResponse', 'Converted to EPUB successfully', result);
            } catch (error) {
                setError('epubResponse', error);
            }
        });

        // Office to PDF Conversion Handlers
        document.getElementById('wordToPdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('wordFile').files[0];
            if (!file) {
                setError('wordToPdfResponse', new Error('Please select a Word document'));
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                const result = await callAPI('/documents/convert/word-to-pdf', formData, 'POST', true);
                
                // Show success message
                setResponse('wordToPdfResponse', 'Word document converted successfully', result);
                
                // Create preview
                const previewContainer = document.getElementById('wordPreview');
                previewContainer.innerHTML = `
                    <div class="alert alert-success">Conversion successful!</div>
                    <div class="mt-3">
                        <a href="${API_BASE_URL}${result.download_url}" class="btn btn-primary" target="_blank">
                            Download PDF
                        </a>
                        <iframe src="${API_BASE_URL}${result.download_url}" class="mt-3"></iframe>
                    </div>
                `;
                
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('wordToPdfResponse', error);
            }
        });

        document.getElementById('excelToPdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                setError('excelToPdfResponse', new Error('Please select an Excel document'));
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                const result = await callAPI('/documents/convert/excel-to-pdf', formData, 'POST', true);
                
                // Show success message
                setResponse('excelToPdfResponse', 'Excel document converted successfully', result);
                
                // Create preview
                const previewContainer = document.getElementById('excelPreview');
                previewContainer.innerHTML = `
                    <div class="alert alert-success">Conversion successful!</div>
                    <div class="mt-3">
                        <a href="${API_BASE_URL}${result.download_url}" class="btn btn-primary" target="_blank">
                            Download PDF
                        </a>
                        <iframe src="${API_BASE_URL}${result.download_url}" class="mt-3"></iframe>
                    </div>
                `;
                
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('excelToPdfResponse', error);
            }
        });

        document.getElementById('pptToPdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('pptFile').files[0];
            if (!file) {
                setError('pptToPdfResponse', new Error('Please select a PowerPoint document'));
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                const result = await callAPI('/documents/convert/ppt-to-pdf', formData, 'POST', true);
                
                // Show success message
                setResponse('pptToPdfResponse', 'PowerPoint document converted successfully', result);
                
                // Create preview
                const previewContainer = document.getElementById('pptPreview');
                previewContainer.innerHTML = `
                    <div class="alert alert-success">Conversion successful!</div>
                    <div class="mt-3">
                        <a href="${API_BASE_URL}${result.download_url}" class="btn btn-primary" target="_blank">
                            Download PDF
                        </a>
                        <iframe src="${API_BASE_URL}${result.download_url}" class="mt-3"></iframe>
                    </div>
                `;
                
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('pptToPdfResponse', error);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const token = getToken();
            if (token) {
                // User is signed in
                document.getElementById('authResponse').innerHTML = 
                    `<div class="alert alert-success">Signed in</div>
                     <button onclick="signOut()" class="btn btn-danger mt-2">Sign Out</button>`;
                listDocuments(); // Load documents when signed in
            } else {
                // User is signed out
                document.getElementById('authResponse').innerHTML = 
                    `<div class="alert alert-info">Please sign in to continue</div>`;
            }
        });
    </script>
</body>
</html> 