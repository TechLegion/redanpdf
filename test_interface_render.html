<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF API Test Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .endpoint-card {
            margin-bottom: 1rem;
        }
        .response-area {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .auth-section {
            background-color: #e9ecef;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
        .document-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .document-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.2s;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .document-preview {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .document-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .document-info {
            padding: 10px;
        }
        .document-title {
            font-size: 0.9rem;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .document-date {
            font-size: 0.8rem;
            color: #666;
            margin: 5px 0;
        }
        .document-actions {
            display: flex;
            gap: 5px;
            padding: 10px;
            border-top: 1px solid #eee;
        }
        .document-actions button {
            flex: 1;
            font-size: 0.8rem;
            padding: 5px;
        }
        .loading-preview {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
        }
        .preview-container {
            margin-top: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
            background: #f8f9fa;
        }
        .preview-container iframe {
            width: 100%;
            height: 500px;
            border: none;
        }
        .preview-container img {
            max-width: 100%;
            height: auto;
        }
        .google-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }
        .google-btn:hover {
            background-color: #3367d6;
        }
        .google-btn:active {
            background-color: #2a56c6;
        }
        .google-logo {
            width: 18px;
            height: 18px;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
</head>
<body>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>PDF API Test Interface</h1>
            <div id="headerAuthSection" style="display: none;">
                <button onclick="signOut()" class="btn btn-outline-danger">
                    <i class="bi bi-box-arrow-right"></i> Sign Out
                </button>
            </div>
        </div>
        
        <!-- Authentication Section -->
        <div class="auth-section">
            <h3>Authentication</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Email/Password Sign In</h5>
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="loginEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Sign In</button>
                            </form>
                            <hr>
                            <h6>Or register a new account</h6>
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label for="registerEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="registerEmail" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="registerPassword" required>
                                </div>
                                <button type="submit" class="btn btn-secondary">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Google Sign In</h5>
                            <button id="googleSignInBtn" class="google-btn" onclick="handleGoogleSignIn()">
                                <svg class="google-logo" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Sign in with Google
                            </button>
                            <button onclick="alert('Test button works!')" class="btn btn-secondary mt-2">Test JavaScript</button>
                            <div class="response-area mt-3" id="authResponse"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Operations Section -->
        <h3 class="mt-4">Document Operations</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Upload PDF</h5>
                        <form id="uploadForm">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="file" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                        <div class="response-area mt-3" id="uploadResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Your Documents</h5>
                        <button class="btn btn-primary" onclick="listDocuments()">Refresh List</button>
                        <div class="response-area mt-3" id="listResponse"></div>
                        <div id="documentsTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Management Section -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Document Details</h5>
                        <form id="documentDetailsForm">
                            <div class="mb-3">
                                <label for="documentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="documentId" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Get Details</button>
                        </form>
                        <div class="response-area mt-3" id="documentDetailsResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Delete Document</h5>
                        <form id="deleteDocumentForm">
                            <div class="mb-3">
                                <label for="deleteDocumentId" class="form-label">Document ID</label>
                                <input type="text" class="form-control" id="deleteDocumentId" required>
                            </div>
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                        <div class="response-area mt-3" id="deleteDocumentResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Conversion Section -->
        <h3 class="mt-4">File Conversion</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Image to PDF</h5>
                        <form id="imageToPdfForm">
                            <div class="mb-3">
                                <label for="imageFiles" class="form-label">Select Images</label>
                                <input type="file" class="form-control" id="imageFiles" accept="image/*" multiple required>
                            </div>
                            <button type="submit" class="btn btn-primary">Convert to PDF</button>
                        </form>
                        <div class="response-area mt-3" id="imageToPdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Office to PDF</h5>
                        <ul class="nav nav-tabs" id="officeTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="word-tab" data-bs-toggle="tab" data-bs-target="#word" type="button" role="tab">Word</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel" type="button" role="tab">Excel</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ppt-tab" data-bs-toggle="tab" data-bs-target="#ppt" type="button" role="tab">PowerPoint</button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3" id="officeTabContent">
                            <div class="tab-pane fade show active" id="word" role="tabpanel">
                                <form id="wordToPdfForm">
                                    <div class="mb-3">
                                        <label for="wordFile" class="form-label">Select Word Document</label>
                                        <input type="file" class="form-control" id="wordFile" accept=".doc,.docx" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Convert to PDF</button>
                                </form>
                                <div class="response-area mt-3" id="wordToPdfResponse">
                                    <div class="preview-container" id="wordPreview"></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="excel" role="tabpanel">
                                <form id="excelToPdfForm">
                                    <div class="mb-3">
                                        <label for="excelFile" class="form-label">Select Excel Document</label>
                                        <input type="file" class="form-control" id="excelFile" accept=".xls,.xlsx" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Convert to PDF</button>
                                </form>
                                <div class="response-area mt-3" id="excelToPdfResponse">
                                    <div class="preview-container" id="excelPreview"></div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="ppt" role="tabpanel">
                                <form id="pptToPdfForm">
                                    <div class="mb-3">
                                        <label for="pptFile" class="form-label">Select PowerPoint Document</label>
                                        <input type="file" class="form-control" id="pptFile" accept=".ppt,.pptx" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Convert to PDF</button>
                                </form>
                                <div class="response-area mt-3" id="pptToPdfResponse">
                                    <div class="preview-container" id="pptPreview"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PDF Operations Section -->
        <h3 class="mt-4">PDF Operations</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Compress PDF</h5>
                        <form id="compressPdfForm">
                            <div class="mb-3">
                                <label for="compressDocumentId" class="form-label">Document ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="compressDocumentId" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="populateDocumentId('compressDocumentId')">Get ID</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Compress PDF</button>
                        </form>
                        <div class="response-area mt-3" id="compressPdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Merge PDFs</h5>
                        <form id="mergePdfForm">
                            <div class="mb-3">
                                <label for="mergeDocumentIds" class="form-label">Document IDs (comma-separated)</label>
                                <input type="text" class="form-control" id="mergeDocumentIds" required>
                            </div>
                            <div class="mb-3">
                                <label for="mergeOutputFilename" class="form-label">Output Filename</label>
                                <input type="text" class="form-control" id="mergeOutputFilename">
                            </div>
                            <button type="submit" class="btn btn-primary">Merge PDFs</button>
                        </form>
                        <div class="response-area mt-3" id="mergePdfResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Watermark PDF</h5>
                        <form id="watermarkPdfForm">
                            <div class="mb-3">
                                <label for="watermarkDocumentId" class="form-label">Document ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="watermarkDocumentId" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="populateDocumentId('watermarkDocumentId')">Get ID</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="watermarkText" class="form-label">Watermark Text</label>
                                <input type="text" class="form-control" id="watermarkText" name="watermark_text" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Watermark</button>
                        </form>
                        <div class="response-area mt-3" id="watermarkPdfResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Extract Text (OCR)</h5>
                        <form id="extractTextForm">
                            <div class="mb-3">
                                <label for="extractTextDocumentId" class="form-label">Document ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="extractTextDocumentId" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="populateDocumentId('extractTextDocumentId')">Get ID</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Extract Text</button>
                        </form>
                        <div class="response-area mt-3" id="extractTextResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Chat with PDF</h5>
                        <form id="chatForm">
                            <div class="mb-3">
                                <label for="chatDocumentId" class="form-label">Document ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="chatDocumentId" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="populateDocumentId('chatDocumentId')">Get ID</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="chatMessage" class="form-label">Message</label>
                                <textarea class="form-control" id="chatMessage" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Message</button>
                        </form>
                        <div class="response-area mt-3" id="chatResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Features Section -->
        <h3 class="mt-4">AI Features</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Summarize PDF</h5>
                        <form id="summarizeForm">
                            <div class="mb-3">
                                <label for="summarizeDocumentId" class="form-label">Document ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="summarizeDocumentId" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="populateDocumentId('summarizeDocumentId')">Get ID</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Summarize</button>
                        </form>
                        <div class="response-area mt-3" id="summarizeResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Convert to EPUB</h5>
                        <form id="epubForm">
                            <div class="mb-3">
                                <label for="epubDocumentId" class="form-label">Document ID</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="epubDocumentId" required>
                                    <button type="button" class="btn btn-outline-secondary" onclick="populateDocumentId('epubDocumentId')">Get ID</button>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Convert to EPUB</button>
                        </form>
                        <div class="response-area mt-3" id="epubResponse"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Legacy PDF Endpoints Section -->
        <h3 class="mt-4">Legacy PDF Endpoints <span class="badge bg-warning text-dark">Legacy</span></h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">Upload PDF (Legacy)</h5>
                        <form id="legacyUploadForm">
                            <div class="mb-3">
                                <input type="file" class="form-control" id="legacyFile" accept=".pdf" required>
                            </div>
                            <button type="submit" class="btn btn-secondary">Upload (Legacy)</button>
                        </form>
                        <div class="response-area mt-3" id="legacyUploadResponse"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card endpoint-card">
                    <div class="card-body">
                        <h5 class="card-title">List PDFs (Legacy)</h5>
                        <button class="btn btn-secondary" onclick="listLegacyPdfs()">Refresh List</button>
                        <div class="response-area mt-3" id="legacyListResponse"></div>
                        <div id="legacyPdfsTable"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Testing Section -->
        <h3 class="mt-4">Error & Edge Case Testing</h3>
        <div class="card endpoint-card">
            <div class="card-body">
                <h5 class="card-title">Send Custom Request</h5>
                <form id="errorTestForm">
                    <div class="mb-3">
                        <label for="customEndpoint" class="form-label">Endpoint (relative to /api/v1)</label>
                        <input type="text" class="form-control" id="customEndpoint" placeholder="/documents/upload" required>
                    </div>
                    <div class="mb-3">
                        <label for="customMethod" class="form-label">HTTP Method</label>
                        <select class="form-control" id="customMethod">
                            <option>GET</option>
                            <option>POST</option>
                            <option>DELETE</option>
                            <option>PUT</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="customBody" class="form-label">Request Body (JSON or leave blank)</label>
                        <textarea class="form-control" id="customBody" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger">Send Request</button>
                </form>
                <div class="response-area mt-3" id="errorTestResponse"></div>
                <div class="response-area mt-3" id="errorTestRaw"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API base URL
        const API_BASE_URL = 'https://redanpdf-1.onrender.com/api/v1';
        
        // Google Sign-In handler function (moved to top)
        function handleGoogleSignIn() {
            console.log('Google Sign-In button clicked!'); // Debug log
            try {
                // Redirect to backend Google OAuth endpoint
                const googleAuthUrl = `${API_BASE_URL}/auth/google/login`;
                console.log('Redirecting to:', googleAuthUrl); // Debug log
                window.location.href = googleAuthUrl;
            } catch (error) {
                console.error('Google Sign-In error:', error); // Debug log
                setError('authResponse', error);
            }
        }
        
        // Get token from localStorage
        function getToken() {
            return localStorage.getItem('token');
        }

        // Generic API call function
        async function callApi(endpoint, data = null, method = 'GET', isFormData = false) {
            console.log(`callApi called with: ${method} ${endpoint}`); // Debug log
            try {
                const token = getToken();
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const headers = {
                    'Authorization': `Bearer ${token}`
                };

                const options = {
                    method: method,
                    headers: headers,
                    mode: 'cors'  // Enable CORS
                };

                // Only add body for non-GET requests
                if (data && method !== 'GET') {
                    if (!isFormData) {
                        headers['Content-Type'] = 'application/json';
                    }
                    options.body = isFormData ? data : JSON.stringify(data);
                }

                console.log(`Making ${method} request to ${API_BASE_URL}${endpoint}`);  // Debug log

                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                console.log(`Response status: ${response.status}`); // Debug log
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Network error' }));
                    console.error('API Error Response:', errorData);  // Debug log
                    throw new Error(errorData.detail || `API request failed with status ${response.status}`);
                }

                // Handle file downloads
                const contentType = response.headers.get('content-type');
                if (contentType && (contentType.includes('application/pdf') || contentType.includes('image/'))) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `converted_${Date.now()}.${contentType.includes('pdf') ? 'pdf' : 'jpg'}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    return { message: 'File downloaded successfully' };
                }

                // Handle JSON responses
                const responseData = await response.json();
                return responseData;
            } catch (error) {
                console.error('API Error:', error);
                if (error.message === 'Failed to fetch') {
                    throw new Error('Unable to connect to the server. The server might be starting up or experiencing issues. Please try again in a few moments.');
                }
                throw error;
            }
        }

        // Set response in UI
        function setResponse(elementId, message, data = null) {
            const element = document.getElementById(elementId);
            if (data) {
                element.innerHTML = `<div class="alert alert-success">${message}</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } else {
                element.innerHTML = `<div class="alert alert-info">${message}</div>`;
            }
        }

        // Set error in UI
        function setError(elementId, error) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const formData = new URLSearchParams();
                formData.append('username', email); // API expects 'username' field for email
                formData.append('password', password);

                const response = await fetch(`${API_BASE_URL}/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Login failed');
                }

                const data = await response.json();
                localStorage.setItem('token', data.access_token);
                updateAuthUI(true); // Update UI for signed in state
                listDocuments(); // Load documents after successful login
            } catch (error) {
                setError('authResponse', error);
            }
        });

        // Register handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Registration failed');
                }

                // After successful registration, log in the user
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const loginResponse = await fetch(`${API_BASE_URL}/auth/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });

                if (!loginResponse.ok) {
                    throw new Error('Registration successful but login failed');
                }

                const loginData = await loginResponse.json();
                localStorage.setItem('token', loginData.access_token);
                updateAuthUI(true); // Update UI for signed in state
                listDocuments(); // Load documents after successful registration
            } catch (error) {
                setError('authResponse', error);
            }
        });

        // Function to update authentication UI
        function updateAuthUI(isSignedIn) {
            const headerAuthSection = document.getElementById('headerAuthSection');
            const authResponse = document.getElementById('authResponse');
            
            if (isSignedIn) {
                // Show header logout button
                headerAuthSection.style.display = 'block';
                // Update auth response area
                authResponse.innerHTML = 
                    `<div class="alert alert-success">Signed in successfully</div>
                     <button onclick="signOut()" class="btn btn-danger mt-2">Sign Out</button>`;
            } else {
                // Hide header logout button
                headerAuthSection.style.display = 'none';
                // Update auth response area
                authResponse.innerHTML = 
                    `<div class="alert alert-info">Please sign in to continue</div>`;
            }
        }

        // Enhanced Sign Out function
        function signOut() {
            console.log('Signing out...'); // Debug log
            
            // Clear authentication data
            localStorage.removeItem('token');
            
            // Clear all response areas
            const responseAreas = [
                'authResponse', 'uploadResponse', 'listResponse', 'documentDetailsResponse',
                'deleteDocumentResponse', 'imageToPdfResponse', 'wordToPdfResponse',
                'excelToPdfResponse', 'pptToPdfResponse', 'compressPdfResponse',
                'mergePdfResponse', 'watermarkPdfResponse', 'extractTextResponse',
                'chatResponse', 'summarizeResponse', 'epubResponse', 'legacyUploadResponse',
                'legacyListResponse', 'errorTestResponse', 'errorTestRaw'
            ];
            
            responseAreas.forEach(areaId => {
                const element = document.getElementById(areaId);
                if (element) {
                    element.innerHTML = '';
                }
            });
            
            // Clear document tables
            const tableElements = ['documentsTable', 'legacyPdfsTable'];
            tableElements.forEach(tableId => {
                const element = document.getElementById(tableId);
                if (element) {
                    element.innerHTML = '';
                }
            });
            
            // Clear preview containers
            const previewContainers = ['wordPreview', 'excelPreview', 'pptPreview'];
            previewContainers.forEach(containerId => {
                const element = document.getElementById(containerId);
                if (element) {
                    element.innerHTML = '';
                }
            });
            
            // Reset auth UI
            document.getElementById('authResponse').innerHTML = 
                `<div class="alert alert-success">Signed out successfully</div>
                 <div class="mt-2">
                     <small class="text-muted">You can sign in again using email/password or Google Sign-In above.</small>
                 </div>`;
            
            // Clear form inputs
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.reset();
            });
            
            // Clear file inputs
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.value = '';
            });
            
            // Update UI to show signed out state
            updateAuthUI(false);
            
            console.log('Sign out completed'); // Debug log
        }

        // Document upload handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            if (!file) {
                setError('uploadResponse', new Error('Please select a file'));
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const result = await callApi('/documents/upload', formData, 'POST', true);
                setResponse('uploadResponse', 'File uploaded successfully', result);
                listDocuments(); // Refresh document list
            } catch (error) {
                setError('uploadResponse', error);
            }
        });

        // List documents
        async function listDocuments() {
            try {
                const documents = await callApi('/documents/list');
                setResponse('listResponse', 'Documents retrieved successfully', documents);
                renderDocumentsTable(documents);
            } catch (error) {
                setError('listResponse', error);
            }
        }

        // Function to populate document ID fields with actual document IDs
        async function populateDocumentId(fieldId) {
            try {
                const documents = await callApi('/documents/list');
                if (documents && documents.length > 0) {
                    const documentId = documents[0].id; // Get the first document ID
                    document.getElementById(fieldId).value = documentId;
                    console.log(`Populated ${fieldId} with document ID: ${documentId}`);
                } else {
                    alert('No documents found. Please upload a document first.');
                }
            } catch (error) {
                alert('Error getting document ID: ' + error.message);
            }
        }

        function renderDocumentsTable(documents) {
            if (!Array.isArray(documents) || documents.length === 0) {
                document.getElementById('documentsTable').innerHTML = '<div class="alert alert-info">No documents found.</div>';
                return;
            }
            let html = '<table class="table table-bordered table-sm mt-2"><thead><tr><th>ID</th><th>Filename</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
            for (const doc of documents) {
                html += `<tr>
                    <td>${doc.id}</td>
                    <td>${doc.filename}</td>
                    <td>${doc.created_at ? new Date(doc.created_at).toLocaleString() : ''}</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="downloadDocument('${doc.id}', '${doc.filename}')" title="Download"><i class="bi bi-download"></i> Download</button>
                        <button class="btn btn-info btn-sm" onclick="previewDocument('${doc.id}')" title="Preview">Preview</button>
                    </td>
                </tr>`;
            }
            html += '</tbody></table><div id="previewModalContainer"></div>';
            document.getElementById('documentsTable').innerHTML = html;
        }

        // Authenticated file download handler
        async function downloadDocument(documentId, filename) {
            try {
                const token = getToken();
                console.log('Download attempt - Document ID:', documentId);
                console.log('Token available:', !!token);
                console.log('Token length:', token ? token.length : 0);
                
                if (!token) {
                    throw new Error('No authentication token found. Please log in.');
                }
                
                const response = await fetch(`${API_BASE_URL}/documents/${documentId}/download`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                console.log('Download response status:', response.status);
                console.log('Download response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Download error response:', errorText);
                    throw new Error(`Download failed: ${response.status} ${response.statusText}`);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || `document_${documentId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (err) {
                console.error('Download error:', err);
                alert('Download failed: ' + err.message);
            }
        }

        // Preview document handler
        async function previewDocument(documentId) {
            const modalHtml = `<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="previewModalLabel">Document Preview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="previewModalBody">
                            <div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
                        </div>
                    </div>
                </div>
            </div>`;
            document.getElementById('previewModalContainer').innerHTML = modalHtml;
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
            try {
                const response = await fetch(`${API_BASE_URL}/documents/${documentId}/preview`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                if (!response.ok) throw new Error('Failed to load preview');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                document.getElementById('previewModalBody').innerHTML = `<img src="${url}" class="img-fluid" alt="Preview">`;
            } catch (err) {
                document.getElementById('previewModalBody').innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
            }
        }

        // Chat with PDF handler
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('chatDocumentId').value;
            const message = document.getElementById('chatMessage').value;
            
            try {
                const result = await callApi('/ai/chat', {
                    query: message,
                    document_id: documentId
                }, 'POST');
                setResponse('chatResponse', 'Chat response received', result);
            } catch (error) {
                setError('chatResponse', error);
            }
        });

        // Summarize PDF handler
        document.getElementById('summarizeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const documentId = document.getElementById('summarizeDocumentId').value;
            
            try {
                const result = await callApi(`/ai/summarize/${documentId}`, null, 'POST');
                setResponse('summarizeResponse', 'Summary generated', result);
            } catch (error) {
                setError('summarizeResponse', error);
            }
        });

        // Grammar check handler
        const grammarForm = document.getElementById('grammarForm');
        if (grammarForm) {
            grammarForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = document.getElementById('grammarText').value;
                
                try {
                    const result = await callApi('/ai/grammar-check', {
                        text: text
                    }, 'POST');
                    setResponse('grammarResponse', 'Grammar check completed', result);
                } catch (error) {
                    setError('grammarResponse', error);
                }
            });
        }

        // Merge PDFs handler
        const mergePdfForm = document.getElementById('mergePdfForm');
        if (mergePdfForm) {
            mergePdfForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const mergeDocumentIdsElement = document.getElementById('mergeDocumentIds');
                const mergeOutputFilenameElement = document.getElementById('mergeOutputFilename');
                
                if (!mergeDocumentIdsElement) {
                    setError('mergePdfResponse', new Error('Merge document IDs field not found'));
                    return;
                }
                
                const documentIds = mergeDocumentIdsElement.value.split(',').map(id => id.trim());
                const outputFilename = mergeOutputFilenameElement ? mergeOutputFilenameElement.value || 'merged.pdf' : 'merged.pdf';
                
                if (!documentIds || documentIds.length === 0 || (documentIds.length === 1 && documentIds[0] === '')) {
                    setError('mergePdfResponse', new Error('Please enter at least one document ID'));
                    return;
                }
                
                const formData = new FormData();
                documentIds.forEach(id => formData.append('document_ids', id));
                formData.append('output_filename', outputFilename);
                
                try {
                    const result = await callApi('/documents/merge', formData, 'POST', true);
                    setResponse('mergePdfResponse', 'PDFs merged successfully', result);
                    listDocuments(); // Refresh document list
                } catch (error) {
                    setError('mergePdfResponse', error);
                }
            });
        }

        // Watermark PDF handler
        const watermarkPdfForm = document.getElementById('watermarkPdfForm');
        if (watermarkPdfForm) {
            watermarkPdfForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const watermarkDocumentIdElement = document.getElementById('watermarkDocumentId');
                const watermarkTextElement = document.getElementById('watermarkText');
                
                if (!watermarkDocumentIdElement) {
                    setError('watermarkPdfResponse', new Error('Watermark document ID field not found'));
                    return;
                }
                
                if (!watermarkTextElement) {
                    setError('watermarkPdfResponse', new Error('Watermark text field not found'));
                    return;
                }
                
                const documentId = watermarkDocumentIdElement.value;
                const watermarkText = watermarkTextElement.value;
                
                if (!documentId) {
                    setError('watermarkPdfResponse', new Error('Please enter a document ID'));
                    return;
                }
                
                if (!watermarkText) {
                    setError('watermarkPdfResponse', new Error('Please enter watermark text'));
                    return;
                }
                
                const formData = new FormData();
                formData.append('watermark_text', watermarkText);
                
                try {
                    const result = await callApi(`/documents/${documentId}/watermark`, formData, 'POST', true);
                    setResponse('watermarkPdfResponse', 'Watermark added successfully', result);
                    listDocuments(); // Refresh document list
                } catch (error) {
                    setError('watermarkPdfResponse', error);
                }
            });
        }

        // Extract text handler
        const extractTextForm = document.getElementById('extractTextForm');
        if (extractTextForm) {
            extractTextForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const extractTextDocumentIdElement = document.getElementById('extractTextDocumentId');
                
                if (!extractTextDocumentIdElement) {
                    setError('extractTextResponse', new Error('Extract text document ID field not found'));
                    return;
                }
                
                const documentId = extractTextDocumentIdElement.value;
                
                if (!documentId) {
                    setError('extractTextResponse', new Error('Please enter a document ID'));
                    return;
                }
                
                try {
                    const result = await callApi(`/documents/${documentId}/extract-text`, null, 'GET');
                    setResponse('extractTextResponse', 'Text extracted successfully', result);
                } catch (error) {
                    setError('extractTextResponse', error);
                }
            });
        }

        // Convert to EPUB handler
        const epubForm = document.getElementById('epubForm');
        if (epubForm) {
            epubForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const epubDocumentIdElement = document.getElementById('epubDocumentId');
                
                if (!epubDocumentIdElement) {
                    setError('epubResponse', new Error('EPUB document ID field not found'));
                    return;
                }
                
                const documentId = epubDocumentIdElement.value;
                
                if (!documentId) {
                    setError('epubResponse', new Error('Please enter a document ID'));
                    return;
                }
                
                try {
                    const result = await callApi(`/documents/${documentId}/to-epub`, null, 'POST');
                    setResponse('epubResponse', 'Converted to EPUB successfully', result);
                } catch (error) {
                    setError('epubResponse', error);
                }
            });
        }

        // Office to PDF Conversion Handlers
        const wordToPdfForm = document.getElementById('wordToPdfForm');
        if (wordToPdfForm) {
            wordToPdfForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = document.getElementById('wordFile').files[0];
                if (!file) {
                    setError('wordToPdfResponse', new Error('Please select a Word document'));
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const result = await callApi('/documents/convert/word-to-pdf', formData, 'POST', true);
                    setResponse('wordToPdfResponse', 'Word document converted successfully', result);
                    // Show download button and PDF preview
                    if (result && result.download_url && result.filename) {
                        const previewContainer = document.getElementById('wordPreview');
                        previewContainer.innerHTML = `
                            <div class="alert alert-success">Conversion successful!</div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="downloadDocumentFromUrl('${result.download_url}', '${result.filename}')">Download PDF</button>
                            </div>
                        `;
                    }
                    listDocuments();
                } catch (error) {
                    setError('wordToPdfResponse', error);
                }
            });
        }

        const excelToPdfForm = document.getElementById('excelToPdfForm');
        if (excelToPdfForm) {
            excelToPdfForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = document.getElementById('excelFile').files[0];
                if (!file) {
                    setError('excelToPdfResponse', new Error('Please select an Excel document'));
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const result = await callApi('/documents/convert/excel-to-pdf', formData, 'POST', true);
                    setResponse('excelToPdfResponse', 'Excel document converted successfully', result);
                    // Show download button and PDF preview
                    if (result && result.download_url && result.filename) {
                        const previewContainer = document.getElementById('excelPreview');
                        previewContainer.innerHTML = `
                            <div class="alert alert-success">Conversion successful!</div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="downloadDocumentFromUrl('${result.download_url}', '${result.filename}')">Download PDF</button>
                            </div>
                        `;
                    }
                    listDocuments();
                } catch (error) {
                    setError('excelToPdfResponse', error);
                }
            });
        }

        const pptToPdfForm = document.getElementById('pptToPdfForm');
        if (pptToPdfForm) {
            pptToPdfForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const file = document.getElementById('pptFile').files[0];
                if (!file) {
                    setError('pptToPdfResponse', new Error('Please select a PowerPoint document'));
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    const result = await callApi('/documents/convert/ppt-to-pdf', formData, 'POST', true);
                    setResponse('pptToPdfResponse', 'PowerPoint document converted successfully', result);
                    // Show download button and PDF preview
                    if (result && result.download_url && result.filename) {
                        const previewContainer = document.getElementById('pptPreview');
                        previewContainer.innerHTML = `
                            <div class="alert alert-success">Conversion successful!</div>
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="downloadDocumentFromUrl('${result.download_url}', '${result.filename}')">Download PDF</button>
                            </div>
                        `;
                    }
                    listDocuments();
                } catch (error) {
                    setError('pptToPdfResponse', error);
                }
            });
        }

        // Legacy PDF endpoints handlers
        async function listLegacyPdfs() {
            try {
                const pdfs = await callLegacyAPI('/pdfs/');
                renderLegacyPdfsTable(pdfs);
            } catch (error) {
                setError('legacyListResponse', error);
            }
        }
        function renderLegacyPdfsTable(pdfs) {
            if (!Array.isArray(pdfs) || pdfs.length === 0) {
                document.getElementById('legacyPdfsTable').innerHTML = '<div class="alert alert-info">No legacy PDFs found.</div>';
                return;
            }
            let html = '<table class="table table-bordered table-sm mt-2"><thead><tr><th>ID</th><th>Filename</th><th>Upload Date</th><th>Actions</th></tr></thead><tbody>';
            for (const pdf of pdfs) {
                html += `<tr>
                    <td>${pdf.id}</td>
                    <td>${pdf.filename}</td>
                    <td>${pdf.upload_date ? new Date(pdf.upload_date).toLocaleString() : ''}</td>
                    <td>
                        <a href="${API_BASE_URL.replace('/api/v1','')}/pdfs/${pdf.id}" class="btn btn-success btn-sm" target="_blank">Download</a>
                        <button class="btn btn-danger btn-sm" onclick="deleteLegacyPdf(${pdf.id})">Delete</button>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('legacyPdfsTable').innerHTML = html;
        }
        async function deleteLegacyPdf(pdfId) {
            if (!confirm('Are you sure you want to delete this legacy PDF?')) return;
            try {
                await callLegacyAPI(`/pdfs/${pdfId}`, null, 'DELETE');
                listLegacyPdfs();
            } catch (error) {
                setError('legacyListResponse', error);
            }
        }
        
        const legacyUploadForm = document.getElementById('legacyUploadForm');
        if (legacyUploadForm) {
            legacyUploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fileInput = document.getElementById('legacyFile');
                const file = fileInput.files[0];
                if (!file) {
                    setError('legacyUploadResponse', new Error('Please select a file'));
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);
                try {
                    await callLegacyAPI('/pdfs/upload', formData, 'POST', true);
                    setResponse('legacyUploadResponse', 'Legacy file uploaded successfully');
                    listLegacyPdfs();
                } catch (error) {
                    setError('legacyUploadResponse', error);
                }
            });
        }
        
        async function callLegacyAPI(endpoint, data = null, method = 'GET', isFormData = false) {
            const options = { method, headers: {} };
            if (!isFormData) options.headers['Content-Type'] = 'application/json';
            if (data) options.body = isFormData ? data : JSON.stringify(data);
            const response = await fetch(`${API_BASE_URL.replace('/api/v1','')}${endpoint}`, options);
            if (!response.ok) throw new Error('Legacy API request failed');
            return await response.json();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, checking for tokens...'); // Debug log
            
            checkForTokenInUrl(); // Check for token from Google OAuth
            const token = getToken();
            if (token) {
                // User is signed in
                updateAuthUI(true); // Update UI for signed in state
                listDocuments(); // Load documents when signed in
            } else {
                // User is signed out
                updateAuthUI(false); // Update UI for signed out state
            }
        });

        // Check for token in URL (from Google OAuth callback)
        function checkForTokenInUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (token) {
                // Store the token
                localStorage.setItem('token', token);
                // Remove token from URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Update UI
                updateAuthUI(true); // Update UI for signed in state
                listDocuments(); // Load documents
            }
        }

        // Error testing handler
        const errorTestForm = document.getElementById('errorTestForm');
        if (errorTestForm) {
            errorTestForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const endpoint = document.getElementById('customEndpoint').value;
                const method = document.getElementById('customMethod').value;
                let body = document.getElementById('customBody').value;
                let data = null;
                try {
                    if (body) {
                        data = JSON.parse(body);
                    }
                } catch (err) {
                    setError('errorTestResponse', new Error('Invalid JSON in request body'));
                    return;
                }
                try {
                    const token = getToken();
                    const headers = { 'Authorization': `Bearer ${token}` };
                    if (method !== 'GET' && method !== 'DELETE') headers['Content-Type'] = 'application/json';
                    const options = { method, headers };
                    if (data) options.body = JSON.stringify(data);
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    const raw = await response.text();
                    let json = null;
                    try { json = JSON.parse(raw); } catch {}
                    setResponse('errorTestResponse', 'Custom request sent', json || raw);
                    document.getElementById('errorTestRaw').innerHTML = `<pre>${raw}</pre>`;
                } catch (error) {
                    setError('errorTestResponse', error);
                }
            });
        }

        function downloadDocumentFromUrl(downloadUrl, filename) {
            const token = getToken();
            console.log('downloadDocumentFromUrl called with:', downloadUrl, filename);
            console.log('Token available:', !!token);
            console.log('Token length:', token ? token.length : 0);
            
            if (!token) {
                alert('No authentication token found. Please log in.');
                return;
            }
            
            fetch(`${API_BASE_URL}${downloadUrl}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => {
                console.log('Download response status:', response.status);
                console.log('Download response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    return response.text().then(errorText => {
                        console.error('Download error response:', errorText);
                        throw new Error(`Download failed: ${response.status} ${response.statusText}`);
                    });
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename || 'converted.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                console.error('Download error:', err);
                alert('Download failed: ' + err.message);
            });
        }

        document.getElementById('compressPdfForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Compress button clicked!'); // Debug log
            try {
                const documentId = document.getElementById('compressDocumentId').value;
                console.log('Attempting to compress document:', documentId); // Debug log
                const response = await callApi(`/documents/${documentId}/compress`, null, 'POST');
                console.log('Compress response:', response); // Debug log
                // Show success message with download link
                const successMessage = `
✅ PDF compressed successfully!

📄 Document ID: ${response.id}
📁 Filename: ${response.filename}
🔗 Download URL: ${response.download_url}
💬 Message: ${response.message}

The compressed PDF has been added to your documents. You can download it using the link above or find it in your document list.
                `;
                document.getElementById('compressPdfResponse').innerHTML = `<div class="alert alert-success">${successMessage.replace(/\n/g, '<br>')}</div>`;
            } catch (error) {
                console.error('Compress error:', error); // Debug log
                document.getElementById('compressPdfResponse').textContent = 'Error: ' + error.message;
            }
        });

        document.getElementById('editTextForm').onsubmit = async function(e) {
          e.preventDefault();
          const docId = document.getElementById('editTextDocumentId').value;
          const page = document.getElementById('editTextPage').value;
          const oldText = document.getElementById('editTextOld').value;
          const newText = document.getElementById('editTextNew').value;
          try {
            const resp = await fetch(`${API_BASE_URL}/pdfs/${docId}/edit_text?page_number=${page}&old_text=${encodeURIComponent(oldText)}&new_text=${encodeURIComponent(newText)}`, {method: 'POST'});
            const result = await resp.json();
            document.getElementById('editTextResponse').textContent = JSON.stringify(result, null, 2);
          } catch (e) { document.getElementById('editTextResponse').textContent = e.message; }
        };
        document.getElementById('addTextForm').onsubmit = async function(e) {
          e.preventDefault();
          const docId = document.getElementById('addTextDocumentId').value;
          const page = document.getElementById('addTextPage').value;
          const text = document.getElementById('addTextContent').value;
          const x = document.getElementById('addTextX').value;
          const y = document.getElementById('addTextY').value;
          const fontSize = document.getElementById('addTextFontSize').value || 12;
          try {
            const resp = await fetch(`${API_BASE_URL}/pdfs/${docId}/add_text?page_number=${page}&text=${encodeURIComponent(text)}&x=${x}&y=${y}&font_size=${fontSize}`, {method: 'POST'});
            const result = await resp.json();
            document.getElementById('addTextResponse').textContent = JSON.stringify(result, null, 2);
          } catch (e) { document.getElementById('addTextResponse').textContent = e.message; }
        };
        document.getElementById('addImageForm').onsubmit = async function(e) {
          e.preventDefault();
          alert('Image upload not implemented in demo. Backend must support image upload.');
        };
        document.getElementById('removeImagesForm').onsubmit = async function(e) {
          e.preventDefault();
          const docId = document.getElementById('removeImagesDocumentId').value;
          const page = document.getElementById('removeImagesPage').value;
          try {
            const resp = await fetch(`${API_BASE_URL}/pdfs/${docId}/remove_images?page_number=${page}`, {method: 'POST'});
            const result = await resp.json();
            document.getElementById('removeImagesResponse').textContent = JSON.stringify(result, null, 2);
          } catch (e) { document.getElementById('removeImagesResponse').textContent = e.message; }
        };
        document.getElementById('annotateForm').onsubmit = async function(e) {
          e.preventDefault();
          const docId = document.getElementById('annotateDocumentId').value;
          const page = document.getElementById('annotatePage').value;
          const type = document.getElementById('annotateType').value;
          const data = document.getElementById('annotateData').value;
          try {
            const resp = await fetch(`${API_BASE_URL}/pdfs/${docId}/annotate?page_number=${page}&annotation_type=${type}&data=${encodeURIComponent(data)}`, {method: 'POST'});
            const result = await resp.json();
            document.getElementById('annotateResponse').textContent = JSON.stringify(result, null, 2);
          } catch (e) { document.getElementById('annotateResponse').textContent = e.message; }
        };
        document.getElementById('reorderPagesForm').onsubmit = async function(e) {
          e.preventDefault();
          const docId = document.getElementById('reorderPagesDocumentId').value;
          const order = document.getElementById('reorderPagesOrder').value;
          try {
            const resp = await fetch(`${API_BASE_URL}/pdfs/${docId}/reorder_pages`, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({new_order: order.split(',').map(x => parseInt(x.trim()))})});
            const result = await resp.json();
            document.getElementById('reorderPagesResponse').textContent = JSON.stringify(result, null, 2);
          } catch (e) { document.getElementById('reorderPagesResponse').textContent = e.message; }
        };
    </script>
</body>
</html> 